# This builds our site with the default parameters in the public/ folder
# of where the repo's been checked out.
#build:
#  image: registry:5001/labs/hugo-build:0.15
#  commands:
#    - hugo
deploy:
  rancher-drone-execute:
    image: eastest/drone-rancher-execute
    url: $$RANCHER_URL
    access_key: $$RANCHER_ACCESS_KEY
    secret_key: $$RANCHER_SECRET_KEY
    service: $$SERVICE_NAME
#chaining the drush commands so that if something fails, the site does not come back online
    cmd: "drush vset site_offline TRUE --root=/var/application/www &&
          drush updb -y &&
          drush vset site_offline FALSE --root=/var/application/www"
    command: "ls -la"
    exec_timeout: 600
  
# Build a docker image for the blog and tag it with "latest" and the
# build number (generated by Drone).
#publish:
#  docker:
#    repo:     eastest/web-application
#    tag:      latest
#    file:     Dockerfile
#    username: $$REGISTERY_USER
#    password: $$REGISTERY_PASSWORD
#    insecure: false

# Deploy the fresh new image to our Rancher environment for QA.
# This creates the containers in the "TechBlog" stack in our environment.
deploy:
  rancher:
    url: $$RANCHER_URL
    access_key: $$RANCHER_ACCESS_KEY
    secret_key: $$RANCHER_SECRET_KEY
    service: $$SERVICE_NAME
    docker_image: $$SERVICE_CONTAINER
    confirm: true
    timeout: 300
